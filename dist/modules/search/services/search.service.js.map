{"version":3,"file":"search.service.js","sourceRoot":"","sources":["../../../../src/modules/search/services/search.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Util } from \"../../../misc/util/index\";\nimport { LookupFn, LookupFnResult, FilterFn } from \"../helpers/lookup-fn\";\n\ninterface ICachedArray<T> { [query:string]:T[]; }\n\nexport class SearchService<T, U> {\n    // Stores the available options.\n    private _options:T[];\n    // Converts a query string into an array of options. Must be a function returning a promise.\n    private _optionsLookup?:LookupFn<T, U>;\n    // Field that options are searched & displayed on.\n    private _optionsField?:string;\n    // Filters a list of options.\n    public optionsFilter:FilterFn<T>;\n\n    public get options():T[] {\n        return this._options;\n    }\n\n    public set options(options:T[]) {\n        this._options = options || [];\n        // We cannot use both local & remote options simultaneously.\n        this._optionsLookup = undefined;\n        // Reset entire service with new options.\n        this.reset();\n    }\n\n    public get optionsLookup():LookupFn<T, U> | undefined {\n        return this._optionsLookup;\n    }\n\n    public set optionsLookup(lookupFn:LookupFn<T, U> | undefined) {\n        this._optionsLookup = lookupFn;\n        // As before, cannot use local & remote options simultaneously.\n        this._options = [];\n        this.reset();\n    }\n\n    public get hasItemLookup():boolean {\n        return !!this.optionsLookup && this.optionsLookup.length === 2;\n    }\n\n    public get optionsField():string | undefined {\n        return this._optionsField;\n    }\n\n    public set optionsField(field:string | undefined) {\n        this._optionsField = field;\n        // We need to reset otherwise we would now be showing invalid search results.\n        this.reset();\n    }\n\n    // Stores the results of the query.\n    private _results:T[];\n    // Cache of results, indexed by query.\n    private _resultsCache:ICachedArray<T>;\n\n    public get results():T[] {\n        return this._results;\n    }\n\n    private _query:string;\n    // Allows the empty query to produce results.\n    public allowEmptyQuery:boolean;\n    // How long to delay the search for when using updateQueryDelayed. Stored in ms.\n    public searchDelay:number;\n    // Stores the search timeout handle so we can cancel it.\n    private _searchDelayTimeout:number;\n    // Provides 'loading' functionality.\n    private _isSearching:boolean;\n\n    public get query():string {\n        return this._query;\n    }\n\n    public get isSearching():boolean {\n        return this._isSearching;\n    }\n\n    constructor(allowEmptyQuery:boolean = false) {\n        this._options = [];\n        this.optionsFilter = (os, q) => {\n            // Convert the query string to a RegExp.\n            const regex = this.toRegex(this._query);\n\n            if (regex instanceof RegExp) {\n                // Only update the results if the query was valid regex.\n                // This avoids the results suddenly becoming empty if an invalid regex string is inputted.\n                return os\n                    // Filter on the options with a string match on the field we are testing.\n                    .filter(o => Util.Object.readValue<T, string>(o, this._optionsField)\n                        .toString()\n                        .match(regex));\n            }\n\n            // Don't update since it wasn't a valid regex.\n            return false;\n        };\n\n        // Set default values and reset.\n        this.allowEmptyQuery = allowEmptyQuery;\n        this.searchDelay = 0;\n        this.reset();\n    }\n\n    // Updates the query after the specified search delay.\n    public updateQueryDelayed(query:string, callback:(err?:Error) => void = () => {}):void {\n        this._query = query;\n\n        clearTimeout(this._searchDelayTimeout);\n        this._searchDelayTimeout = window.setTimeout(\n            () => {\n                this.updateQuery(query, callback);\n            },\n            this.searchDelay\n        );\n    }\n\n    // Updates the current search query.\n    public updateQuery(query:string, callback:(err?:Error) => void = () => {}):void {\n        this._query = query;\n\n        if (this._query === \"\" && !this.allowEmptyQuery) {\n            // Don't update if the new query is empty (and we don't allow empty queries).\n            // Don't reset so that when animating closed we don't get a judder.\n            return callback();\n        }\n\n        if (this._resultsCache.hasOwnProperty(this._query)) {\n            // If the query is already cached, make use of it.\n            this._results = this._resultsCache[this._query];\n\n            return callback();\n        }\n\n        if (this._optionsLookup) {\n            this._isSearching = true;\n\n            // Call the options lookup without a this context.\n            const queryLookup = this._optionsLookup.call(undefined, this._query) as LookupFnResult<T[]>;\n\n            queryLookup\n                .then(results => {\n                    this._isSearching = false;\n\n                    this.updateResults(results);\n                    return callback();\n                })\n                .catch(error => {\n                    // Unset 'loading' state, and throw the returned error without updating the results.\n                    this._isSearching = false;\n                    return callback(error);\n                });\n\n            return;\n        }\n\n        const filtered = this.optionsFilter.call(undefined, this._options, this._query);\n        if (filtered) {\n            this.updateResults(filtered);\n        }\n        return callback();\n    }\n\n    // Updates & caches the new set of results.\n    private updateResults(results:T[]):void {\n        this._resultsCache[this._query] = results;\n        this._results = results;\n    }\n\n    // tslint:disable-next-line:promise-function-async\n    public initialLookup(initial:U):LookupFnResult<T>;\n    // tslint:disable-next-line:promise-function-async\n    public initialLookup(initial:U[]):LookupFnResult<T[]>;\n    // tslint:disable-next-line:promise-function-async\n    public initialLookup(initial:U | U[]):LookupFnResult<T> | LookupFnResult<T[]> {\n        if (initial instanceof Array) {\n            return (this._optionsLookup as LookupFn<T, U[]>)(undefined, initial) as LookupFnResult<T[]>;\n        }\n        return (this._optionsLookup as LookupFn<T, U>)(undefined, initial) as LookupFnResult<T>;\n    }\n\n    // Converts a query string to regex without throwing an error.\n    private toRegex(query:string):RegExp | string {\n        try {\n            return new RegExp(query, \"i\");\n        } catch (e) {\n            return query;\n        }\n    }\n\n    // Generates HTML for highlighted match text.\n    public highlightMatches(text:string, query:string):string {\n        const regex = this.toRegex(query);\n        if (regex instanceof RegExp) {\n            return text.replace(regex, match => `<b>${match}</b>`);\n        }\n        return text;\n    }\n\n    // Resets the search back to a pristine state.\n    private reset():void {\n        this._results = [];\n        this._resultsCache = {};\n        this._isSearching = false;\n        this.updateQuery(\"\");\n    }\n}\n"]}